---
title: "Interesting Visualizations"
#author: "Alice Chen, Yuqiao Leng, JoÃ«l Merki, Emma Clark, Kavya Mahesh"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    highlight: zenburn
    number_sections: yes
    toc: yes
    toc_float: yes
    code_folding: show
editor_options: 
  markdown: 
    wrap: 72
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE, 
  warning = FALSE, 
  tidy=FALSE,     # display code as typed
  size="small")   # slightly smaller font for code
options(digits = 3)

# default figure size
knitr::opts_chunk$set(
  fig.width=6.75, 
  fig.height=6.75,
  fig.align = "center"
)
```

```{r load-libraries, include=FALSE}
library(tidyverse)  # Load ggplot2, dplyr, and all the other tidyverse packages
library(mosaic)
library(ggthemes)
library(lubridate)
library(here)
library(skimr)
library(janitor)
library(httr)
library(readxl)
library(vroom)
library(wbstats)
library(countrycode)
library(patchwork)
library(gganimate)
```

# Excess rentals in TfL bike sharing

TfL data: How many bikes were hired every single day:

```{r, get_tfl_data, cache=TRUE}
url <- "https://data.london.gov.uk/download/number-bicycle-hires/ac29363e-e0cb-47cc-a97a-e216d900a6b0/tfl-daily-cycle-hires.xlsx"

```

```{r, store in temp file, include=FALSE}
# Download TFL data to temporary file
httr::GET(url, write_disk(bike.temp <- tempfile(fileext = ".xlsx")))
```

```{r, store bike data}

# Use read_excel to read it as dataframe
bike0 <- read_excel(bike.temp,
                   sheet = "Data",
                   range = cell_cols("A:B"))

# change dates to get year, month, and week
bike <- bike0 %>% 
  clean_names() %>% 
  rename (bikes_hired = number_of_bicycle_hires) %>% 
  mutate (year = year(day),
          month = lubridate::month(day, label = TRUE),
          week = isoweek(day))

```

### Monthly changes in TfL bike rentals:

```{r, Monthly changes in TfL bike rentals}

# creating a data frame to calculate the monthly average for years 16 to 19
bike_16to19 <- bike %>% 
  filter (year %in% 2016:2019) %>% 
  group_by (month) %>% 
  summarize (avg_bikes_16to19 = mean(bikes_hired))

# creating a data frame to calculate the monthly averages for each year from 17 to 22
bike_17to22 <- bike %>% 
  filter (year %in% 2017:2022) %>% 
  group_by (month, year) %>% 
  summarize (avg_bikes_17to22 = mean(bikes_hired))

# joining the two data frames to create one data frame that can be used for the creation of the graph
joined <- left_join(bike_17to22, bike_16to19)

# plotting monthly changes in TfL bike rentals faceted by year 
ggplot(joined, aes(x = month, group = year)) + 
  geom_line(aes(y = avg_bikes_16to19), group = 1, color = "blue", size = 1) + 
  geom_line(aes(y = avg_bikes_17to22, group = 1)) + 
  geom_ribbon (aes (ymin = avg_bikes_17to22, ymax = pmax(avg_bikes_16to19, avg_bikes_17to22)), fill = "red", alpha=0.3) +
  geom_ribbon (aes (ymin = avg_bikes_16to19, ymax = pmax(avg_bikes_16to19, avg_bikes_17to22)), fill = "green", alpha=0.3) +
  facet_wrap(~ year) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Monthly changes in TfL bike rentals", 
       subtitle = "Change from monthly average shown in blue and calculated between 2016 - 2019", 
       x = "", 
       y = "Bike rentals", 
       caption = "Source: TfL, London Data Store") 


```

### Percentage changes from the expected level of weekly rentals:

```{r, Weekly Changes in TfL bike rentals}

# creating a data frame to calculate the weekly average for years 16 to 19
bike_16to19_weekly <- bike %>% 
  filter (year %in% 2016:2019) %>% 
  group_by (week) %>% 
  summarize (avg_bikes_16to19_weekly = mean(bikes_hired))

# creating a data frame to calculate the weekly averages in bike rentals for each year from 17 to 22
bike_17to22_weekly <- bike %>% 
  filter (year %in% 2017:2022) %>% 
  group_by (week, year) %>% 
  summarize (avg_bikes_17to22_weekly = mean(bikes_hired))

# joining the two data frames to create one data frame that can be used for the creation of the graph
joined_weekly <- left_join(bike_17to22_weekly, bike_16to19_weekly)

# adding two columns to calculate the percent change and filter out data value in week 52 of year 2022
joined_weekly_mutated <- joined_weekly %>% 
  mutate (Excess_rentals = avg_bikes_17to22_weekly - avg_bikes_16to19_weekly) %>% 
  mutate (Excess_rentals_Perc = Excess_rentals / avg_bikes_16to19_weekly * 100) %>% 
  filter(!(week >= 52 & year == 2022)) %>% 
  mutate(color_id = if_else(Excess_rentals_Perc > 0,
                          "Positive",
                          "Negative")) 

# plotting the weekly percentage changes 
ggplot(joined_weekly_mutated, aes(x = week, y = Excess_rentals_Perc)) + 
  geom_line() + 
  
# creating rectangles to highlight Q2 and Q4
  geom_rect(aes(x = week, xmin = 14, xmax = 26, ymin = -50, ymax = 100), fill = "grey", alpha = 0.01) + 
  geom_rect(aes(x = week, xmin = 40, xmax = 52, ymin = -50, ymax = 100), fill = "grey", alpha = 0.01) +
  
  facet_wrap (~ year) +
  theme_bw() +
  
#adding fill in between lines and rug at the bottom
  geom_ribbon(aes(ymin=0, ymax=pmax(Excess_rentals_Perc,0)), fill="green", col="black", alpha=0.2) +
  geom_ribbon(aes(ymin=pmin(Excess_rentals_Perc,0), ymax=0), fill="red", col="black", alpha=0.2) + 
  geom_rug(mapping = aes(color = color_id), sides = "b", show.legend = FALSE) +
  scale_color_manual(values = c("red", "green")) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  labs(title = "Weekly Changes in TfL bike rentals", 
       subtitle = "% change from weekly average calculated between 2016 annd 2019",
       x = "Week", 
       y = "Bike Rentals",
       caption = "Source: TfL, London Data Store")

```

We have chosen the mean to calculate our expected bike rentals because it
allows for a more realistic prediction of future bike rentals. Many
outliers are cause by events such as tube strikes which are not one-off
occurrences and are likely to repeat in the future. Furthermore, the
expected rentals are calculated using data from three years so the
extreme points are softened.

# Share of renewable energy production in the world

Source: The National Bureau of Economic Research (NBER) dataset on the adoption of about 200 technologies in more than 150
countries since 1800. This is the[Cross-country Historical Adoption of
Technology (CHAT)
dataset](https://www.nber.org/research/data/cross-country-historical-adoption-technology).


Load Data: 

```{r,load_technology_data}

technology <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-07-19/technology.csv')

#get all technologies
labels <- technology %>%
  distinct(variable, label)

# Get country names using 'countrycode' package
technology <- technology %>% 
  filter(iso3c != "XCD") %>% 
  mutate(iso3c = recode(iso3c, "ROM" = "ROU"),
         country = countrycode(iso3c, origin = "iso3c", destination = "country.name"),
         country = case_when(
           iso3c == "ANT" ~ "Netherlands Antilles",
           iso3c == "CSK" ~ "Czechoslovakia",
           iso3c == "XKX" ~ "Kosovo",
           TRUE           ~ country))

#make smaller dataframe on energy
energy <- technology %>% 
  filter(category == "Energy")

# download CO2 per capita from World Bank using {wbstats} package
# https://data.worldbank.org/indicator/EN.ATM.CO2E.PC
co2_percap <- wb_data(country = "countries_only", 
                      indicator = "EN.ATM.CO2E.PC", 
                      start_date = 1970, 
                      end_date = 2022,
                      return_wide=FALSE) %>% 
  filter(!is.na(value)) %>% 
  #drop unwanted variables
  select(-c(unit, obs_status, footnote, last_updated))

# get a list of countries and their characteristics
# we just want to get the region a country is in and its income level
countries <-  wb_cachelist$countries %>% 
  select(iso3c,region,income_level)

```

This is a very rich data set, not just for energy and CO2 data, but for
many other technologies. Renewable Contribution is made up of
`elec_hydro`, `elec_solar`, `elec_wind`, and `elec_renew_other`.

### Animation to explore the relationship between CO2 per capita emissions
and the deployment of renewables:

```{r Creating animation using ggplot}

library(gifski)
library(png)

energy[,c("variable","iso3c","year","value")] %>% 
  
  #subsetting required rows from energy dataset based on the variable column (types of energy)
  filter(variable %in% c("elec_hydro", "elec_solar", "elec_wind", "elec_renew_other","elecprod")) %>% 
  
  #pivot wider based on the variable electricity type 
  pivot_wider(names_from = variable, values_from = value) %>% 
  
  #calculate sum of renewable energy and % of renewable contribution to total (elecprod)
  mutate(renewable_energy = elec_hydro + elec_solar + elec_wind + elec_renew_other,
         percent_renewable_contribution = renewable_energy/elecprod) %>% 
  
  #joining with Co2 per capita dataset based on columns iso3c (code) and year: value = CO2 per capita
  inner_join(co2_percap, by = c("iso3c", "year" = "date")) %>% 
  
  #Joining with dataset specifying income level of countries based on col iso3c
  inner_join (countries, by="iso3c") %>% 
  
  #Subsetting only required columns
  select(iso3c,country, year, income_level, percent_renewable_contribution, value) %>% 
  rename(CO2_per_cap = value) %>% 
  arrange(desc(percent_renewable_contribution)) %>% 
  
  #Plotting ggplot graph (% renewable contribution vs CO2 per cap)
  ggplot(aes(x=percent_renewable_contribution, y=CO2_per_cap, color=income_level)) +
  geom_point(size=2) +
  scale_x_continuous(labels = scales::percent_format()) +
  facet_wrap(~income_level) +
  theme_bw() +
  theme(legend.position = "none") +
  labs(title = 'Year: {frame_time}', 
       x = '% renewables', 
       y = 'CO2 per cap') +
  
  #Animating ggplot graph
  transition_time(as.integer(year)) +
  ease_aes('linear')


```

General Observations:

> In high income and upper middle income countries, there is a more
> pronounced relationship over the years between CO2 per cap reduction
> and % renewable increase. Countries in these 2 categories also have
> much higher CO2 per cap output than low and lower middle income and
> show higher variability in CO2 emissions as seen from the vertical
> movement of points in the animation. The lower middle and low income
> countries have lower CO2 per capita emissions and we do not see a
> change in these emissions as the % of renewable energy change. In the
> high income nations, the decrease in CO2 emissions over time could be
> a result of the Paris Agreement that was signed in 2015.
>
> Lower income countries are very often developing nations which took
> longer to get access to renewable technology. We also note that in the
> earlier years we do not have as much data for the low and lower middle
> income countries compared to the high and upper middle income nations.
